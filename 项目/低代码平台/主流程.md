# 低代码平台主流程

## 一、整体架构

```
┌────────────────────────────────────────────┐
│               Designable (设计态)          │
│--------------------------------------------│
│  Engine → TreeNode → Operation → Schema    │
│  ↑                                         │
│  可视化编辑、节点管理、撤销重做、组件配置   │
└────────────────────────────────────────────┘
                    ↓ transformToSchema
┌────────────────────────────────────────────┐
│               Formily (运行态)             │
│--------------------------------------------│
│  Schema → Form → Field → Reaction → UI     │
│  ↑                                         │
│  响应式状态、校验逻辑、渲染真实组件         │
└────────────────────────────────────────────┘
```

## 二、Designable —— 设计态的抽象

### 🧭 定义

Designable 是一个「元数据可编辑引擎」：
- 它不是表单框架，而是一个 Schema 的可视化编辑系统
- 在设计态中，你操作的不是组件本身，而是组件的"抽象描述"

### 🔧 关键抽象对象

| 对象 | 含义 |
|------|------|
| Engine | 整个设计器运行引擎 |
| TreeNode | 设计态节点，描述"未来组件" |
| Operation | 一次操作（可撤销/重做） |
| Workspace / Viewport | 画布状态 |
| DesignerProps | 设计约束（是否可拖拽、删除） |


### 核心概念

- **每一个拖入画布的组件**，都会生成一个 TreeNode
- **每一个 TreeNode** 对应未来运行时的一个 Formily 字段或容器
- **节点树（NodeTree）** 是运行时 Schema 的「中间态描述」

### 🧠 思维模型

```
交互行为（拖拽/修改） → Node Tree 更新 → Schema 变化 → JSON 存储
```

**关键特点：**
- 你操作的是「元」：即组件的配置、结构、位置、约束
- 没有数据模型、没有真实渲染逻辑
- 一切行为都被抽象成「编辑 Schema」的动作（insert, move, update, delete）


## 三、Formily —— 运行态的抽象

### 🧭 定义

Formily 是一个「响应式表单引擎」：
- 它的输入是 Schema，输出是渲染出的表单组件和联动逻辑

### 核心概念

- **每一个 Schema 节点** 会映射到一个 Field 实例
- **每个 Field** 负责管理自己的 value、state、visible、pattern 等

### 🧠 思维模型

```
Schema → Form/Field 实例化 → 渲染 → 响应式联动（Reactions）
```

### 抽象重点

- **数据模型**（FormState）
- **UI 组件映射**（x-component）
- **反应式系统**（依赖收集）
- **生命周期与校验机制**（Validator, Effect）

### 🧠 Formily = Schema 解释器

- UI 层通过组件注册机制（组件映射）实现渲染
- Formily 运行时并不知道什么是 "Input"、"Select"
- 它只是通过一个「组件注册表」来找到 UI 对应的实现

### 关键特性

- **Schema** = 表单描述；组件根据 widget 字段渲染
- **表单状态**：values/errors/updateField 三件套
- **难点**：对象/数组类型递归渲染

## 四、回滚机制

### 🎯 设计态回滚
- **操作历史**：保存每次操作的前后状态，支持撤销/重做
- **快照机制**：关键节点创建深拷贝快照，可快速恢复
- **快捷键**：Ctrl+Z 撤销，Ctrl+Y 重做

### 🎯 运行态回滚  
- **表单状态**：保存表单数据的历史版本
- **字段回滚**：单个字段可独立回滚到之前状态
- **版本管理**：Schema 版本控制，支持回滚到任意版本

### 🎯 核心策略
- **分层回滚**：UI层、数据层、持久化层分别处理
- **性能优化**：增量保存、内存限制、异步处理
- **用户体验**：即时反馈、进度提示、错误处理

