# 🧭 低代码平台主链路

## 一、总体流程图

```
┌──────────────┐
│  Designable  │  ← 拖拽组件、修改属性
│  (设计态)     │
└──────┬───────┘
       │ transformToSchema()
       ▼
┌──────────────┐
│   Schema     │  ← JSON 描述表单结构与组件属性
│ (结构描述)   │
└──────┬───────┘
       │ 存储 (DB / 文件 / API)
       ▼
┌──────────────┐
│   Formily    │  ← 解析 Schema，生成表单 Field
│  (运行态)    │
└──────┬──────┘
       │ createForm / createSchemaField
       ▼
┌──────────────┐
│   Render UI  │  ← 渲染出 Input、Select 等真实组件
└──────┬──────┘
       │ 表单交互 (输入、校验、提交)
       ▼
┌──────────────┐
│  数据持久化  │  ← 保存表单值 (Config)
└──────────────┘
```

---

## 二、详细执行链路

### 1️⃣ 设计态（Designable）

**输入**：组件元信息（注册表）  
**输出**：Schema（JSON）

**流程：**

1. 用户在可视化设计器中 **拖拽组件 → 属性编辑 → 保存**；
2. Designable 内部用 `TreeNode` 描述组件层级关系；
3. 每次操作封装为 `Operation`（支持撤销/重做）；
4. 设计器引擎 `Engine` 将 NodeTree 转换为标准 JSON Schema：
   ```js
   const schema = engine.getCurrentTree().serialize();
   ```
5. 前端通过 API 将 `schema` 持久化到后端。

👉 **设计态产物：schema.json（结构模板）**

---

### 2️⃣ 存储层

**输入**：schema  
**输出**：schema + config

**逻辑：**

- 后端保存两类数据：
  - `schema`：组件结构、字段定义；
  - `config`：表单值、配置数据；
- 支持版本号（如 v1、v2、v3）；
- 通过接口 `/api/schema/:id`、`/api/config/:id` 提供 CRUD。

---

### 3️⃣ 运行态（Formily）

**输入**：schema + config  
**输出**：渲染出的动态表单 + 字段映射关系

**核心原理：**

Formily 是一个 **Schema 驱动的渲染引擎**，它不会写死组件结构，而是通过解析 `schema` 的层级、`x-component` 与 `x-decorator` 信息，动态生成对应的 React 节点。

---

**流程：**

1. **加载后端返回的 schema 与 config：**
   ```ts
   const { schema, config } = await fetch("/api/schema-config").then((res) =>
     res.json()
   );
   ```
2. **创建表单实例与组件映射：**

   ```ts
   const form = createForm();
   const SchemaField = createSchemaField({
     components: { FormItem, Input, Select, Switch, Text },
   });
   ```

   > ✅ 每个 `x-component` 对应一个真实组件：
   >
   > - `"Input"` → `<Input />`
   > - `"Select"` → `<Select />`
   > - `"Text"` → 文本显示组件
   > - `"Switch"` → 开关组件  
   >   `"x-decorator": "FormItem"` 决定是否包裹在 Form.Item 内（提供 label、校验提示等）。

3. **初始化表单数据：**

   ```ts
   form.setValues(config);
   ```

4. **渲染阶段：**

   ```tsx
   <FormProvider form={form}>
     <SchemaField schema={schema} />
   </FormProvider>
   ```

   - Formily 递归遍历 Schema 树：
     - 每个节点生成对应 Field；
     - 将 `schema.name` 映射为 `form.values` 的字段路径；
     - 组件属性（如 placeholder、title、x-validator）自动绑定。

5. **字段映射关系：**

   | schema 字段    | 绑定数据路径               | 渲染组件类型 | 示例               |
   | -------------- | -------------------------- | ------------ | ------------------ |
   | `discord_link` | `form.values.discord_link` | `Input`      | Discord 链接输入框 |
   | `title`        | `form.values.title`        | `Text`       | 静态文本标题       |
   | `isVisible`    | `form.values.isVisible`    | `Switch`     | 布尔开关           |

   > 🧩 Formily 根据 schema 描述，自动完成 **字段注册、依赖追踪、响应式更新**。

---

### 4️⃣ 数据交互与保存

**输入**：用户交互数据  
**输出**：新的 config

**流程：**

1. 用户修改表单；
2. Formily 自动更新 `form.values`；
3. 点击保存按钮，POST 回后端：
   ```ts
   fetch("/api/config", {
     method: "POST",
     body: JSON.stringify(form.values),
   });
   ```
4. 后端更新 `config` 字段。

👉 **数据与结构解耦：config ≠ schema**

---

### 5️⃣ 回滚机制

**设计态回滚**

- 每次操作（Operation）会生成一个快照；
- 支持 Ctrl+Z / Ctrl+Y 撤销、重做；
- 快照存储在引擎内存或 IndexedDB。

**运行态回滚**

- 表单状态保存历史值；
- 支持单字段回滚；
- schema 层支持版本号回退。

---

## 三、主链路关键点总结

| 阶段   | 关键对象                      | 核心职责             | 二次开发要做的事             |
| ------ | ----------------------------- | -------------------- | ---------------------------- |
| 设计态 | Engine / TreeNode / Operation | 拖拽生成 Schema      | 注册自定义组件               |
| 存储层 | schema.json / config.json     | 保存结构与数据       | 提供 schema/config CRUD 接口 |
| 运行态 | Form / Field / SchemaField    | 渲染、联动、校验     | 编写渲染逻辑、数据绑定       |
| 交互层 | FormProvider / Button         | 用户操作与提交       | 封装保存逻辑                 |
| 回滚层 | History / Snapshot            | 撤销、重做、版本控制 | 可视化版本管理               |

---
