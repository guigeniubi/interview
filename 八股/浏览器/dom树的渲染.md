# 🧩 DOM 渲染流程（面试版）

> **一句话概述：**
> 浏览器将 HTML 转换为页面的过程包括：解析 → 构建 DOM/CSSOM → 渲染树 → 布局 → 绘制 → 合成。

---

## 一、整体流程

```
HTML → DOM → CSSOM → Render Tree → Layout → Paint → Composite
```

---

## 二、关键阶段

### 1️⃣ HTML 解析（DOM 构建）

- 词法分析生成 Token
- 语法分析生成 DOM 树
- 遇到 `<script>` 会阻塞解析
  > ✅ 优化：`defer` / `async` 异步加载脚本

---

### 2️⃣ CSS 解析（CSSOM 构建）

- 解析样式规则，计算优先级与继承
- 构建 CSSOM 树
  > ⚠️ CSS 加载会阻塞渲染树生成（渲染阻塞）

---

### 3️⃣ 合成渲染树（Render Tree）

- 合并 DOM + CSSOM
- 只包含可见节点（`display:none` 不参与）

---

### 4️⃣ 布局（Layout / Reflow）

- 计算每个元素的位置与尺寸
- 改变尺寸、结构会触发重排（Reflow）

---

### 5️⃣ 绘制（Paint）

- 绘制背景、边框、文字等视觉元素
- 改变颜色、阴影触发重绘（Repaint）

---

### 6️⃣ 合成（Composite）

- 将不同图层合并为最终画面
- `transform`、`opacity` 等属性可单独合成层 → 提高性能

---

## 三、重排与重绘

| 类型                | 触发条件           | 性能影响 |
| ------------------- | ------------------ | -------- |
| **Reflow（重排）**  | 元素结构或尺寸变化 | 🚨 高    |
| **Repaint（重绘）** | 视觉样式变化       | ⚠️ 中    |

> ✅ 优化：批量修改样式、使用 `transform`/`opacity`、读写分离

---

## 四、性能优化方向

1. **减少阻塞**：JS 用 `defer/async`，内联关键 CSS
2. **减少重排**：批量改样式、用虚拟滚动、`requestAnimationFrame` 动画
3. **利用 GPU 加速**：`will-change`、`transform`
4. **减少 DOM 数量**：长列表虚拟化

---

## 五、总结（面试回答模板）

> 浏览器渲染大致分为 6 步：  
> ① 解析 HTML 构建 DOM；  
> ② 解析 CSS 构建 CSSOM；  
> ③ 合并生成渲染树；  
> ④ 布局计算位置与尺寸；  
> ⑤ 绘制像素；  
> ⑥ 图层合成。
>
> 性能优化重点是**减少重排重绘、避免渲染阻塞、利用 GPU 合成层**。
